#!/usr/bin/env bash

set -euox pipefail

export RUSTFLAGS="-Cinstrument-coverage"

MODE=${1:-"debug"}

rm -rf coverage && mkdir coverage

echo '[~] Running server coverage...'

CARGO_INCREMENTAL=0 \
  RUSTFLAGS='-Cinstrument-coverage' \
  LLVM_PROFILE_FILE='cargo-test-%p-%m.profraw' \
  cargo test --all --all-targets

echo '[~] Running client coverage...'

pnpm run test --coverage

echo '[~] Generating server coverage report...'

if [ "$MODE" = "debug" ]; then
  FMT=html
  SERVER_FILE=coverage/server.html
  CLIENT_FILE=coverage/client.html
else
  FMT=lcov
  SERVER_FILE=coverage/server.lcov
  CLIENT_FILE=coverage/client.lcov
fi

grcov . \
  --binary-path ./target/debug/deps \
  -s . \
  -t $FMT \
  --branch \
  --ignore-not-existing \
  --ignore "../*" \
  --ignore "/*" \
  -o $SERVER_FILE

echo '[~] Copying client coverage report...'

if [ "$MODE" = "debug" ]; then
  cp -r client/coverage $CLIENT_FILE
else
  cp client/coverage/lcov.info $CLIENT_FILE
fi

echo '[~] Combining coverage reports...'

if [ "$MODE" = "debug" ]; then
  echo "Server coverage: coverage/server.html"
  echo "Client coverage: coverage/client.html"
else
  cat $SERVER_FILE $CLIENT_FILE > coverage/tests.lcov
fi

echo '[~] Cleaning up...'

find . -type f -name "*.profraw" -exec rm {} \;
